---

- name: install neovim
  ansible.builtin.apt:
    name:
      - neovim
      - python3-pynvim
      - git
    update_cache: true
    cache_valid_time: 3600
  tags: apt

  become: "{{ neovim_become_admin }}"
  become_user: "{{ neovim_become_admin_user }}"

- block:
    - name: ensure ~/.config/nvim and subfolders exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
      with_items:
        - ~/.config/nvim
        - ~/.config/nvim/lua
        - ~/.config/nvim/lua/plugins

    - name: install packer.nvim from git
      ansible.builtin.git:
        repo: https://github.com/wbthomason/packer.nvim
        dest: ~/.local/share/nvim/site/pack/packer/start/packer.nvim
        depth: 1

    - name: install init.lua
      ansible.builtin.copy:
        src: config/nvim/init.lua
        dest: ~/.config/nvim/init.lua
        owner: "{{ neovim_become_user }}"
        group: "{{ neovim_become_user }}"
        mode: 0640

    - name: install plugins config
      ansible.builtin.copy:
        src: "config/nvim/lua/plugins/{{ item }}"
        dest: "~/.config/nvim/lua/plugins/{{ item }}"
        owner: "{{ neovim_become_user }}"
        group: "{{ neovim_become_user }}"
        mode: 0640
      with_items:
        - gitsigns.lua
        - indent-blankline.lua
        - kommentary.lua
        - lspconfig.lua
        - lualine.lua
        - nvim-autopairs.lua
        - nvim-cmp.lua
        - nvim-tree.lua
        - packer.lua
        - telescope.lua
        - todo-comments.lua
        - trouble.lua

    - name: install general settings
      ansible.builtin.copy:
        src: "config/nvim/lua/{{ item }}"
        dest: "~/.config/nvim/lua/{{ item }}"
        owner: "{{ neovim_become_user }}"
        group: "{{ neovim_become_user }}"
        mode: 0640
      with_items:
        - settings.lua

  become: "{{ neovim_become }}"
  become_user: "{{ neovim_become_user }}"
